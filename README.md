# HighResolutionBot
Телеграм бот, который улучшает качество фотографий

Бот: @HighResolution_bot
Сейчас бот не работает из-за приостановки его работы на сервере 

# 1. Выбор нейросети для бота
Изначально я хотела создать полезоного и удобного бота для улучшения качества отпраляемых ему сообщений, потому начала искать соответствубщие GAN. Первым мне попался ESRGAN от xinntao[1], но результаты её работы показались мне недостаточно хорошими, потому я выбрала улученную версию этой сети от того же создателя - Real-ESRGAN. При прикручивании именно этой версии возникли непреодолимые тредности, поэтому, порывшись в GitHub, я нашла более удобный репозиторий, созданный ai-forever[2].
На обучение настолько же хорошей сети у меня не было ни технических ресурсов, ни времени, поэтому я остановилась на Real-ESRGAN
[1]https://github.com/xinntao/ESRGAN
[2]https://github.com/ai-forever/Real-ESRGAN

# 2. Телеграм бот
@BotFather помог создать бота; библиотека, сделавшая его работатспособным - aiogram.
Все-все зависимости лежат в requirements.txt, токен - в файле .env

Как всё работает:
1. Сначала с ботом надо поздороваться комнадой /start
2. Далее он попросит отправить ему фото, документ в формате .png, .jpg или **неанимированный** стикер. Если ему что-то не понрмавится, он об этом сообщит.  
3. Если функционал бота кажется неочевидным, команда /help во всплывающей клавиатуре расскажет что да как 
4. В случае, когда бот долго обрабатывает фотографию, то есть более 10 минут, прервать его работу можно либо командой /restart, либо /upscale_image
5. Бот асинхронный, потому сразу несколько пользователей могут с ним общаться)

 PS: с асинхронностью пришлось помучаться, потому что функция, обраатывающая фото была блокирующей, но это решилось парочкой async и await


 ## 3. Докер и деплой
Создание докер-образа и его последующее размещение на сервере реализовано на ПО Docker [1]. Давайте поближе посмотрим на процесс развёртывания сервера:

1. Сначала скачиваем Docker Desktop для вашей операционной системы [2]. **Начиная с пункта 3**, приложение **должно** быть запущено. 
2. Для проекта пишем 2 файла: с зависимостями вашего бота - requirements.txt, и непосредственно сам Dockerfile со всеми необходимыми командами. Последний можно написать в VSCode, установив расширение "Docker" от Microsoft. [3]
![image](https://github.com/tipofyzik/ImageStyling_tgbot/assets/84290230/f74565bf-d25c-4dc4-866c-aa56df11ca37)  
3. В консоли переходим в директорию, где находится ваш проект и Dockerfile. Затем пишем следующую команду:  
**docker build -t your_image_name path_to_dockerfile**  
После ввода команды начнётся процесс сборки docker-образа. После завершения сборки вы сможете протестировать работу образа, запустив его при помощи команды:  
**docker run your_image_name**  
5. Далее нас интересует выгрузка docker-образа. Заходим на docker-hub [4], проходим регистрацию и входим в аккаунт. Возвращаемся в нашу консоль и пишем **docker login** для входа в аккаунт, далее пишем следующие команды:  
**docker tag your_image_name dockerhub_username/your_image_name**  
**docker push dockerhub_username/your_image_name**  
Первая строчка создаёт новое имя для нашего образа - это нужно для загрузки на docker-hub, которая происходит после введения второй строчки. По завершении загрузки, Desktop Docker, как и консоль нам больше не потребуются.

Теперь всё, что нужно - docker playground [5] - сайт от docker.com, позволяющий запускать хоть и ограниченную по памяти (4GB), но бесплатную 4х часовую сессию. На наше счастье, предоставленных ресурсов достаточно для работы бота. Заходим на сайт, выбираем Lab Environment:  
![image](https://github.com/tipofyzik/ImageStyling_tgbot/assets/84290230/13d41a2e-242a-4031-b4c6-7d32a7c29718)  
Логинимся, нажимаем "start". Теперь нам нужно лишь нажать "add new instance" и ввести команду:  
**docker run -it dockerhub_username/your_image_name**  
После чего наш образ c docker hub загрузится и бот запустится.

your_image_name - имя вашего докер-образа  
dockerhub_username - ник в docker hub  
path_to_dockerfile - путь к папке, где лежит Dockerfile  

В силу всего вышесказанного, можно понять, что бота постоянно поддерживать тяжело в силу ограничений по времени и памяти. Поэтому он отключён

**!Замечание:**  
Когда пишете Dockerfile и файл с зависимостями проекта, очень рекомендую устанавливать лишь самый минимум, необходимый для работы бота (да и проекта в целом).  Например, если в requirements.txt вы просто укажете версию для библиотеки torch, то в образ будет скачиваться довольно большой пакет, в котором, в частности, будет находится функционал для работы с GPU, который для работы проекта вообще не нужен. В данном случае лучше поставить версию torch лишь для CPU, это существенно снизит размер скачиваемого пакета. По этой же причине поставлен лишь базовый образ Python и почищен весь кэш. Благодаря подобному решению, финальный размер образа удалось уменьшить с исходных 7.5ГБ до примерно 1ГБ, что очень хорошо в условиях ограниченных бесплатных ресурсов.  

Источники:  
[1] https://ru.wikipedia.org/wiki/Docker  
[2] https://www.docker.com/  
[3] https://code.visualstudio.com/docs/containers/overview  
[4] https://hub.docker.com/  
[5] https://www.docker.com/play-with-docker/ 


## 4. Тесты
Их пока нет)


## 5. Ограничения и отнкости
1. Нейронка RealESRGAN обучалась на заблюренных или низкокачественных фото, так что чего-то экстроординарного от обработки 2k фото ждать не стоит. 4k так де не стоит заливать, так как просто нехватит вычислительных ресурсов, бот об этом не скажет и в вашем с ним чате будет сохраняться многозначительное молчание, пока у вас не лопнет терпение
2. Наибольшую боль доставил модуль самой неройнки, адекватно подключающийся при запуске с локальной системы и отказывающийся работать при упаковки проекта в Docker. На момент написание этого абзаца проблема не была решена

## 6. Результаты 

    
